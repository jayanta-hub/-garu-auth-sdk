<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App 2 - Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .auth-status {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .authenticated {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }
        .not-authenticated {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .card h3 {
            margin-top: 0;
            color: #fff;
        }
        .card p {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .user-info h2 {
            margin-top: 0;
            color: #fff;
        }
        .user-info p {
            margin: 10px 0;
            font-size: 16px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .logout-btn {
            background: #f44336;
        }
        .logout-btn:hover {
            background: #da190b;
        }
        .auth-methods {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .method {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .method h4 {
            margin-top: 0;
            color: #fff;
        }
        .method p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä App 2 - Dashboard</h1>
        
        <div id="authStatus" class="auth-status not-authenticated">
            <h2>üîí Not Authenticated</h2>
            <p>Please login in App 1 to access this dashboard</p>
            <button onclick="window.open('./app1-login.html', '_blank')">Go to Login</button>
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <h2>üë§ User Information</h2>
            <p><strong>Name:</strong> <span id="userName"></span></p>
            <p><strong>Email:</strong> <span id="userEmail"></span></p>
            <p><strong>Role:</strong> <span id="userRole"></span></p>
            <p><strong>Token:</strong> <span id="userToken"></span></p>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>

        <div id="dashboard" class="dashboard" style="display: none;">
            <div class="card">
                <h3>üìà Analytics</h3>
                <p>View your performance metrics</p>
                <button onclick="showAnalytics()">View Analytics</button>
            </div>
            
            <div class="card">
                <h3>üë• Users</h3>
                <p>Manage user accounts</p>
                <button onclick="manageUsers()">Manage Users</button>
            </div>
            
            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <p>Configure your preferences</p>
                <button onclick="openSettings()">Open Settings</button>
            </div>
            
            <div class="card">
                <h3>üìä Reports</h3>
                <p>Generate detailed reports</p>
                <button onclick="generateReport()">Generate Report</button>
            </div>
        </div>

        <div class="auth-methods">
            <h3>üîê Authentication Methods Used</h3>
            
            <div class="method">
                <h4>üç™ Shared Cookies (Same Domain)</h4>
                <p>This app automatically receives authentication from App 1 via shared cookies when both apps are on the same domain.</p>
                <p><strong>Status:</strong> <span id="cookieStatus">Checking...</span></p>
            </div>
            
            <div class="method">
                <h4>üîó URL Parameters</h4>
                <p>Authentication can be shared via URL parameters for cross-domain applications.</p>
                <p><strong>Status:</strong> <span id="urlStatus">Ready</span></p>
            </div>
            
            <div class="method">
                <h4>üì° Cross-Origin Communication</h4>
                <p>Authentication can be shared between different origins using postMessage API.</p>
                <p><strong>Status:</strong> <span id="crossOriginStatus">Ready</span></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { authManager } from '../dist/index.js';

        // Check authentication status on load
        checkAuthStatus();

        // Subscribe to auth changes
        authManager.subscribe((user) => {
            if (user) {
                showAuthenticatedState(user);
            } else {
                showUnauthenticatedState();
            }
        });

        // Setup external auth listener
        authManager.constructor.listenForExternalChanges();

        // Process auth from URL if present
        if (authManager.processAuthFromUrl()) {
            console.log('Authentication received from URL parameters');
        }

        function checkAuthStatus() {
            if (authManager.isLoggedIn()) {
                const user = authManager.getUser();
                if (user) {
                    showAuthenticatedState(user);
                }
            } else {
                showUnauthenticatedState();
            }
            
            // Update method statuses
            updateMethodStatuses();
        }

        function showAuthenticatedState(user) {
            document.getElementById('authStatus').className = 'auth-status authenticated';
            document.getElementById('authStatus').innerHTML = `
                <h2>‚úÖ Authenticated</h2>
                <p>Welcome to App 2, ${user.name}!</p>
            `;
            
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userRole').textContent = user.role || 'N/A';
            
            const token = authManager.getToken();
            document.getElementById('userToken').textContent = token ? token.substring(0, 20) + '...' : 'N/A';
            
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('dashboard').style.display = 'grid';
        }

        function showUnauthenticatedState() {
            document.getElementById('authStatus').className = 'auth-status not-authenticated';
            document.getElementById('authStatus').innerHTML = `
                <h2>üîí Not Authenticated</h2>
                <p>Please login in App 1 to access this dashboard</p>
                <button onclick="window.open('./app1-login.html', '_blank')">Go to Login</button>
            `;
            
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
        }

        function updateMethodStatuses() {
            // Check cookie status
            const cookieToken = document.cookie.includes('auth_token');
            document.getElementById('cookieStatus').textContent = cookieToken ? '‚úÖ Active' : '‚ùå Not Found';
            
            // Check URL status
            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlAuth = urlParams.has('auth_token');
            document.getElementById('urlStatus').textContent = hasUrlAuth ? '‚úÖ Received' : '‚è≥ Waiting';
            
            // Check cross-origin status
            document.getElementById('crossOriginStatus').textContent = '‚è≥ Waiting for message';
        }

        window.logout = function() {
            authManager.logout();
        };

        window.showAnalytics = function() {
            alert('Analytics feature - This would show user-specific analytics data');
        };

        window.manageUsers = function() {
            alert('User Management - This would show user management interface');
        };

        window.openSettings = function() {
            alert('Settings - This would open user-specific settings');
        };

        window.generateReport = function() {
            alert('Report Generation - This would generate a report for the authenticated user');
        };

        // Listen for cross-origin auth sharing
        window.addEventListener('message', (event) => {
            if (event.data.type === 'AUTH_SHARE') {
                console.log('Received auth via postMessage:', event.data.auth);
                document.getElementById('crossOriginStatus').textContent = '‚úÖ Received via postMessage';
                
                // Auto-login if the auth is valid
                const { token, user, timestamp } = event.data.auth;
                if (Date.now() - timestamp < 5 * 60 * 1000) { // 5 minutes
                    authManager.login(user, token);
                }
            }
        });

        // Update method statuses periodically
        setInterval(updateMethodStatuses, 2000);
    </script>
</body>
</html>
